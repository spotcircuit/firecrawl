<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Adjustable 4-Corner Overlay + Webhook Submit</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
  <style>
    body { margin:0; padding:0; }
    #map { width:100%; height:80vh; }
    #controls { padding:10px; background:#f8f8f8; }
    #controls input { width:150px; margin-right:8px; }
    #controls button { margin-right:8px; }
  </style>
</head>
<body>
  <div id="controls">
    <input type="text" id="latInput" placeholder="Center Lat (e.g. 39.0997)" />
    <input type="text" id="lngInput" placeholder="Center Lng (e.g. -94.5786)" />
    <button id="setCenter">Set Center</button>
    <button id="submitCorners">Submit Corners</button>
  </div>
  <div id="map"></div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- smallest-enclosing-circle -->
  <script src="https://unpkg.com/smallest-enclosing-circle/dist/smallest-enclosing-circle.min.js"></script>
  <script>
    // 1. Initialize map with default center
    const defaultCenter = [39.0997, -94.5786]; // Kansas City, MO
    const defaultZoom = 11;
    const map = L.map('map').setView(defaultCenter, defaultZoom);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // 2. Create 4 draggable corner markers
    const corners = [
      L.marker([39.15, -94.80], { draggable: true }).addTo(map),
      L.marker([39.15, -94.30], { draggable: true }).addTo(map),
      L.marker([38.80, -94.30], { draggable: true }).addTo(map),
      L.marker([38.80, -94.80], { draggable: true }).addTo(map),
    ];

    // 3. Polygon and circle overlays
    const quad = L.polygon(corners.map(m => m.getLatLng()), {
      color: 'blue', weight: 2, fillOpacity: 0.05
    }).addTo(map);

    let circ = L.circle([0,0], { radius: 0, color: 'red', weight: 2 }).addTo(map);

    // 4. Update on drag
    corners.forEach(m => m.on('drag', updateOverlay));

    // 5. Button handlers
    document.getElementById('setCenter').onclick = () => {
      const lat = parseFloat(document.getElementById('latInput').value);
      const lng = parseFloat(document.getElementById('lngInput').value);
      if (!isNaN(lat) && !isNaN(lng)) {
        map.setView([lat, lng], defaultZoom);
      } else {
        alert('Please enter valid numbers for lat & lng');
      }
    };

    document.getElementById('submitCorners').onclick = () => {
      // Gather data
      const pts = corners.map(m => m.getLatLng());
      // Compute MEC
      const cart = pts.map(p => [p.lng, p.lat]);
      const mec = circleEnclose(cart);
      const centerLat = mec.y;
      const centerLng = mec.x;
      const metersPerDegLat = 111320;
      const metersPerDegLng = 40075000 * Math.cos(centerLat * Math.PI/180) / 360;
      const avgScale = (metersPerDegLat + metersPerDegLng)/2;
      const radiusMeters = mec.r * avgScale;

      const payload = {
        corners: pts.map(p => ({ lat: p.lat, lng: p.lng })),
        circle: { center: { lat: centerLat, lng: centerLng }, radius: radiusMeters }
      };

      fetch('https://n8n.spotcircuit.com/webhook-test/SendCords', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(res => {
        if (res.ok) alert('Corners submitted successfully!');
        else alert('Error submitting corners: ' + res.statusText);
      })
      .catch(err => alert('Fetch error: ' + err));
    };

    // 6. Overlay update function
    function updateOverlay() {
      const pts = corners.map(m => m.getLatLng());
      quad.setLatLngs(pts);
      const cart = pts.map(p => [p.lng, p.lat]);
      const mec = circleEnclose(cart);
      const center = L.latLng(mec.y, mec.x);
      const metersPerDegLat = 111320;
      const metersPerDegLng = 40075000 * Math.cos(center.lat * Math.PI/180) / 360;
      const avgScale = (metersPerDegLat + metersPerDegLng)/2;
      const radiusMeters = mec.r * avgScale;
      circ.setLatLng(center).setRadius(radiusMeters);
    }

    // initial draw
    updateOverlay();
  </script>
</body>
</html>
